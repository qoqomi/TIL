# System Structure & Program Execution 1

## 컴퓨터 시스템의 구조

1. 컴퓨터 시스템의 구조<br>
   컴퓨터 내부장치 CPU ,메모리와 컴퓨터 외부 장치인 디스크, 키보드, 마우스, 모니터, 네트워크 장치 등으로 구성된다.

2. 컨트롤러

- 일종의 작은 CPU
- 컴퓨터 전체에 CPU라는 중앙 처리장치가 있듯이 컨트롤러는 각 하드웨어 장치마다 존재하면서 이들을 제어하는 작은 cpu라고 할 수 있다.
  (예를 들어 디스크에 붙어 있으면 디스크 컨트롤러임)

3. 진행속도 : CPU>>>>>>Disk

4. 커널(kernel) : 운영체제 중 항상 메모리에 올라가 있는 부분은 전체 운영체제 중 핵심적인 부분에 한정되며 이 부분을 커널이라 한다.

## Device Controller

1. I/O device controller
   - 해당 I/O 장치유형을 관리하는 일종의 작은 CPU
   - 제어 정보를 위해 control register, status register를 가짐
   - local buffer를 가짐 (일종의 data register)
   - I/O는 실제 device와 local buffer사이에서 일어남
   - Device controller는 I/O가 끝났을 경우 interrupt로 cpu에 그 사실을 알림

> **device driver(장치 구동기)**: OS코드 중 각 장치 별 처리루틴-> software <br> **device controller(장치 제어기)** : 각 장치를 통제하는 일종의 작은 cpu->hardware

## CPU 와 IO 연산

1. 로컬버퍼(local buffer) <br>
   A프로그램은 하드디스크에서 어떠한 정보를 읽어오는 작업을 수행하는 상황이고 B프로그램은 현재 CPU를 할당받아 프로그램 코드를 수행하는 상황이라면 두가지 일이 다른곳에서 일어나고 있기 때문에 동시에 수행되는 것이 가능하다. <br>
   한편 **각 장치마다 이를 제어하기 위한 장치 컨트롤러는 각 장치들로부터 오고 나가는 데이터를 임시로 저장하기 위한 작은 메모리** 를 가지고 있는데 이를 로컬 버퍼라고 한다.

2. 인터럽트 : 컨트롤러들이 cpu의 서비스가 필요할 때 이를 통보하는 방법 (컨트롤러가 인터럽트를 발생시켜 cpu에 보고한다.)

3. cpu는 명령 하나를 수행할 때마다 인터럽트가 발생했는지 확인한다.

**순서 : 외부기기 << 컨트롤러 << 로컬버퍼 << cpu**
( 프로그램이 요청한 데이터를 디스크컨트롤러가 로컬버퍼로 읽어온 후 인터럽트를 발생시키면 cpu는 인터럽트가 들어옴을 인지하고 인터럽트 관련 업무를 수행한다. )

## 인터럽트의 일반적인 기능

### 인터럽트의 종류

1. 하드웨어 인터럽트
   - 컨트롤러 등 하드웨어 장치가 cpu의 인터럽트 라인을 세팅
   - 통상적으로 가르키는 인터럽트
2. 소프트웨어 인터럽트 (= 트랩trap)
   - 소프트웨어가 그 일을 수행한다.
   - 트랩 (trap)으로 불린다.
   - 예로는 **예외상황(exception)** or **시스템 콜(system call)** 이 있다.
   - 예외상황 or 시스템콜은 사용자 프로세스로부터 cpu제어권이 운영체제에 이양되어 처리된다-> 이 과정에 인터럽트 라인을 지나가기 때문에 인터럽트라고 말한다.
3. 예외상황(exception)
   - 사용자 프로그램이 0으로 나누는 연산 등 비정상적인 작업을 시도하거나, 자신의 메모리 영역 바깥에 접근하려는 시도 등 권한이 없는 작업을 시도할 때 이에 대한 처리를 위해 발생시키는 인터럽트를 말한다.
4. 시스템 콜(system call)
   - 사용자 프로그램이 운영체제에게 I/O요청
   - trap을 사용하여 인터럽트 벡터의 특정위치로 이동
   - 제어권이 인터럽트 벡터가 가르키는 인터럽트 서비스 루틴으로 이동
   - 올바른 I/O 요청인지 확인 후 I/O 수행
   - I/O 완료 시 제어권을 시스템콜 다음 명령으로 옮김

### 인터럽트 벡터와 처리루틴

- 인터럽트 벡터 : 해당 인터럽트의 처리 루틴 주소를 가지고 있음 (위치)

- 인터럽트 처리루틴(interrupt service roution) or 인터럽트 핸들러(interrupt handler)
  해당 인터럽트를 처리하는 커널 함수

## 인터럽트 핸들링

1. 인터럽트 핸들링(interrupt handling) : 인터럽트가 발생한 경우에 처리해야 할 일의 절차를 의미

2. 현재상태: 현재 cpu에서 실행 중인 명령의 메모리 주소를 포함해 몇 가지 부가적인 정보들을 의미

3. 레지스터(register)

   - cpu내부에 있는 임시기억장치
   - cpu 내 명령이 실행될 때에 여기에서 데이터를 읽거나 쓰면서 작업하는데 이때 인터럽트가 발생해 새로운 명령을 실행하면 기존의 레지스터 값들이 지워진다 !! -> **저장해주는 PCB**

4. PCB(Process Control Block) : 운영체제는 현재 시스템 내에서 실행되는 프로그램들을 관리하기 위해 프로세스 제어블록이라는 자료구조를 둔다.

## Timer

- 특정프로그램이 cpu를 독점하는 것을 막기 위한 것.

## DMA(Direct Memory Access: 직접 메모리를 접근할 수 있는 컨트롤러)

I/O장치가 cpu에게 인터럽트를 너무 많이 걸려서 생긴 일종의 컨트롤러

1. DMA
   - 일종의 컨트롤러
   - 원칙적으로 메모리는 cpu에 의해서만 접근할 수 있는 장치이다.
   - cpu에게 인터럽트를 발생시키면 cpu는 컨트롤러의 로컬버퍼와 메모리 사이에는 데이터를 옮기는 일을 하게 된다.

## Mode bit

1. 사용자 프로그램의 잘못된 수행으로 다른 프로그램 및 운영체제에 피해각 가지 않도록 하기 위한 **보호 장치** 필요

2. mode bit을 통해 하드웨어적으로 두 가지 모드를 operation 지원
   > **1 사용자 모드** : 사용자 프로그램 수행 (cpu가 사용자 프로그램 수행)-> 제한된 instruction만 <br> > **0 모니터 모드(커널모드)** : OS 코드 수행 (운영체제가 cpu에서 실행)-> 모든 접근 가능

- 보안을 해칠 수 있는 중요한 명령어는 모니터 모드에서만 수행가능
- interrpt나 exception 발생시 하드웨어가 mode bit을 0으로 바꿈
- 사용자 프로그램에게 cpu를 넘기기 전에 mode 1로 셋팅

모니터 모드 (=커널모드, 시스템 모드)

운영체제(메모리)가 cpu에서 실행중

## 정리

1. I/O 요청을 할 때에는 소프트웨어 ,I/O 요청이 끝났으면 하드웨어로 결국 두가지 다 필요함
2. 운영체제는 cpu를 사용할 일이 없고 인터럽트가 들어올때만 cpu가 운영체제에 넘어가는것이다 -> 그렇지 않다면 항상 사용자 프로그램에서 사용되는 것이다.
